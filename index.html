<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity WebGL Player | Unleash Play</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
</head>

<body style="text-align: center; padding: 0; border: 0; margin: 0;">

<div id="start-screen">
    <div id="background-icons">
      <p id="loading-text"></p>
    </div>
</div>


  <div id="unity-container" style="display: none;">
    <canvas id="unity-canvas" width=540 height=960 tabindex="-1"
      style="width: 540px; height: 960px; background: #231F20"></canvas>
  </div>

  <!-- Vanilla code for unity canvas game -->
  <!--<canvas id="unity-canvas" width=540 height=960 tabindex="-1"
    style="width: 540px; height: 960px; background: #231F20"></canvas>-->

  <script src="Build/kittycross3.loader.js"></script>

  <script>

    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      // Mobile device style: fill the whole browser client area with the game canvas:
      var meta = document.createElement('meta');
      meta.name = 'viewport';
      meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
      document.getElementsByTagName('head')[0].appendChild(meta);

      var canvas = document.querySelector("#unity-canvas");
      canvas.style.width = "100%";
      canvas.style.height = "100%";
      canvas.style.position = "fixed";

      document.body.style.textAlign = "left";
    }

  // Customized Js Code for initializing game with loading design

  const startScreen = document.querySelector("#start-screen");
  const unityContainer = document.querySelector("#unity-container");


  let MyGameInstance = "";

  const unityCanvas = document.querySelector("#unity-canvas");
  const config = {
  dataUrl: "Build/kittycross3.data",
  frameworkUrl: "Build/kittycross3.framework.js",
  codeUrl: "Build/kittycross3.wasm",
  streamingAssetsUrl: "StreamingAssets",
  companyName: "HSI",
  productName: "Unleash Play",
  productVersion: "1.2.2 (127)",
};

// Make loading bar follow real Unity progress
function UnityProgress(progress) {
  const loadingText = document.getElementById("loading-text");
  const versionText = document.getElementById("version-text");



  if (progress < 1) {
    // While loading: update loading bar
    loadingText.textContent = "";
  } else {
    // Finished loading: hide bar, show PLAY, clear texts
    startScreen.style.display = "none";
    unityContainer.style.display = "block";
    
    unityInstancePromise.then(unityInstance => {
    MyGameInstance = unityInstance;
    sendTokenToUnity();
    });
  }
}

/*Create unity instance and load the config of the game.
  The promise result is stored on the variable. */
const unityInstancePromise = createUnityInstance(unityCanvas, config, (progress) => {
  UnityProgress(progress);
});

// startButton.onclick = async () => {
//   // Disable the start button once clicked
//   startButton.disabled = true;

//   try {
//     // Await if unityinstance promise result is completed
//     const unityInstance = await unityInstancePromise;

//     // Disable the loading screen and enable the game screen
//     startScreen.style.display = "none";
//     unityContainer.style.display = "block";

//     // Assign the unityInstance to a variable that can be used anywhere in the script
//     MyGameInstance = unityInstance;

//     // Unity game is loaded. UnityInstance can be used to send message and etc
//     console.log("Unity Ready!");
//     sendTokenToUnity();

//   } catch (error) {
//     alert("Unity Loading Failed: " + error);
//     startButton.disabled = false;
//   }
// };

// Send the token of the user back to unity once the game instance is created
function sendTokenToUnity() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");
  
  if (token && MyGameInstance) {
    console.log("Sending token:", token);
    // Removed the 5s timeout; usually better to send once 'await' finishes
    MyGameInstance.SendMessage("API Manager", "ReceiveToken", token);
  }
}

  // Gets the state of flutter app then send the state back to unity to pause and unpase the audio
  let state;

    function sendAppStateToUnity() {
      window.onFlutterMessage = function (msg) {
        console.log('Received message from Flutter:', msg);

        state = JSON.stringify(msg);

        if (MyGameInstance) {
          MyGameInstance.SendMessage("Sound Handler", "ReceiveValue", state);
        }

        if (msg.action === 'pause') {
          // Pause game/audio
          console.log('Pausing due to', msg.reason);
        }
      };
    }

    sendAppStateToUnity();

  </script>
</body>

</html>
